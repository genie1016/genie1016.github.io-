# app.py
# It-Girl Self-Love Diary â€” High-Contrast Pastel (White/Pink/Lilac) + Heart Cover + SVG Particles

from flask import Flask, request, jsonify, render_template_string, url_for
from datetime import datetime
import argparse, random

app = Flask(__name__, static_folder="static")

# ---------------- 1) Reply logic (ê·¸ëŒ€ë¡œ) ----------------
KEYWORDS = {
    "stress": ["í˜ë“¤", "ì§€ì³¤", "ë²ˆì•„ì›ƒ", "í”¼ê³¤", "ìŠ¤íŠ¸ë ˆìŠ¤"],
    "selfDoubt": ["ë¶ˆì•ˆ", "ìì‹ ", "ìì¡´ê°", "ê±±ì •", "ì´ˆì¡°"],
    "mistake": ["ì‹¤ìˆ˜", "ë§í–ˆ", "í›„íšŒ", "ì°½í”¼", "ë¯¼ë§"],
    "relationship": ["ì¹œêµ¬", "ì—°ì• ", "ê´€ê³„", "íŒ€", "íšŒì‚¬"],
    "challenge": ["ë„ì „", "ìƒˆë¡œìš´", "ì‹œì‘", "ë©´ì ‘", "ì‹œí—˜"],
    "procrastination": ["ë¯¸ë£¨", "ê²Œìœ¼", "ì§‘ì¤‘", "ë£¨í‹´", "ìŠµê´€"],
}
TONES = ["warm", "itgirl", "coach"]
REPLIES = {
    "stress": {
        "warm": [
            "ë¶€ë”ªíˆëŠ” ë‚ ë„ ìˆì§€. ê·¸ë˜ë„ í–‰ìš´ì€ ëŠ˜ ë„¤ í¸ì´ë˜.ğŸ€",
            "ì˜¤ëŠ˜ ìˆ˜ê³ í–ˆì–´. ë”°ëœ»í•œ ì°¨ í•œ ì”ì²˜ëŸ¼ ë§ˆìŒì„ ë®ì–´ì£¼ì.",
            "íŒë‹¨ì€ ë‚´ì¼ì—ê²Œ ë§¡ê¸°ì. ì§€ê¸ˆì€ ì‰¬ì–´ë„ ì¶©ë¶„íˆ ê°€ì¹˜ ìˆì–´.",
            "ìˆ¨ì„ ê¹Šê²Œ ì‰¬ê³  ì–´ê¹¨ í¸ ë‹¤ìŒ, ì˜¤ëŠ˜ì˜ ë‚˜ë¥¼ ê¼­ ì•ˆì•„ì¤˜.",
        ],
        "itgirl": [
            "ì˜¤ëŠ˜ ë¬´ë“œëŠ” ë„¤ê°€ ì •í•´! ë‹¤ë¥¸ ì‚¬ëŒì´ ë­ë¼ í•´ë„ ë„Œ ë„ˆë¼ì„œ ì¶©ë¶„í•´.  ",
            "ìŠ¤íŠ¸ë ˆìŠ¤? ë‚œ ë£¨í‹´ìœ¼ë¡œ ì»¨íŠ¸ë¡¤í•´. ë¬¼ ë§ˆì‹œê³  ìŠ¤íŠ¸ë ˆì¹­ 1ë¶„, ë¦¬ì…‹!",
            "ë°”ì ìˆ˜ë¡ ë” ë¹›ë‚˜ëŠ” ë¬´ë“œ. ì˜¤ëŠ˜ë„ ì£¼ì¸ê³µì€ ë‚˜ì•¼ âœ¨",
            "ë‚´ í˜ì´ìŠ¤ëŠ” ë‚´ê°€ ì •í•´. ì²œì²œíˆ ê°€ë„ ê¾¸ì¤€íˆ ìŒ“ì—¬.",
        ],
        "coach": [
            "â€œë‚œ ë‚˜ì¼ ë•Œ ê°€ì¥ ë¹›ë‚˜.â€ ë”°ë¼ê°ˆ í•„ìš” ì—†ì–´â€”ë„Œ ë„ˆì˜ ê¸¸ë¡œ. ğŸš€",
            "10ë¶„ íšŒë³µ ë£¨í‹´: ë¬¼â†’ìŠ¤íŠ¸ë ˆì¹­â†’ì°½ ë°– ë³´ê¸°. ê·¸ë‹¤ìŒ í•œ ê°€ì§€ë§Œ ì²˜ë¦¬.",
            "í•  ì¼ 3ê°œë¡œ ì¤„ì´ê¸°. ì‘ì€ ìŠ¹ë¦¬ë¶€í„° ìŒ“ì.",
            "í”¼ê³¤ì§€ìˆ˜ 1~5 ê¸°ë¡. 4 ì´ìƒì´ë©´ íšŒë³µ ë¨¼ì €!",
        ],
    },
    "selfDoubt": {
        "warm": [
            "ë‚œ ë‚˜ì¼ ë•Œ ê°€ì¥ ë¹›ë‚˜!âœ¨ ìŠì§€ ë§ê³ , ê¸¸ì„ ìƒì–´ë„ ê´œì°®ì•„.",
            "ë¶ˆì•ˆí•´ë„ ê´œì°®ì•„. ë„¤ ê°€ì¹˜ëŠ” í”ë“¤ë¦¬ì§€ ì•Šì•„.",
            "ì˜¤ëŠ˜ì˜ ë‚˜ë„ ì¶©ë¶„íˆ ì˜ˆì˜ê³  ë‹¨ë‹¨í•´.",
            "ê±±ì •ì˜ í¬ê¸°ë³´ë‹¤, ë‚´ê°€ í•´ë‚¸ ê²ƒì˜ ëª©ë¡ì„ ë” í¬ê²Œ ì“°ì.",
        ],
        "itgirl": [
            "ë¬´ë“œëŠ” ë‚´ê°€ ì •í•´. ë‚¨ ëˆˆì¹˜ NOâ€”ëŒë¦¬ì§€ ì•ŠëŠ” ê²ƒì—” ì•ˆ ëŒë ¤.",
            "ê±°ìš¸ ë³´ê¸°. ì´ë¯¸ â€˜ë² ìŠ¤íŠ¸ ë²„ì „â€™ ê°±ì‹  ì¤‘ ğŸ’–",
            "ê¸°ì¤€ì€ ë‚´ê°€ ë§Œë“ ë‹¤. ì˜¤ëŠ˜ë„ ìê¸°í™•ì‹  ON.",
            "ë¹„êµëŠ” OFF, ë‚˜ë‹¤ì›€ì€ MAX.",
        ],
        "coach": [
            "ìì‹ ê° ë£¨í‹´: ê±°ìš¸ ì•ì—ì„œ â€œëˆ„êµ¬ë³´ë‹¤ë„ ë¨¼ì € ë‚˜ë¥¼ ë¯¿ì–´â€ 3íšŒ!",
            "ì¦ê±° 3ê°€ì§€ ì ê¸°: í•´ë‚¸ ì¼, ë°›ì€ ì¹­ì°¬, ë²„í‹´ ìˆœê°„.",
            "24ì‹œê°„ ë¹„êµ ê¸ˆì§€ ì±Œë¦°ì§€ ì‹œì‘!",
            "ë¶ˆì•ˆ í•œ ì¤„ â†’ ë°˜ë°• í•œ ì¤„. ê· í˜• ì¡ê¸°.",
        ],
    },
    "mistake": {
        "warm": [
            "ì‹¤ìˆ˜ëŠ” ì„±ì¥ì˜ ì´ì •í‘œì•¼. ì˜¤ëŠ˜ì€ ë‹¤ì •í•˜ê²Œ ë„˜ì–´ê°€ì.",
            "í•˜ë£¨ì˜ í•œ ì¥ë©´ì¼ ë¿, ì „ì²´ ì„œì‚¬ëŠ” ì¶©ë¶„íˆ ì•„ë¦„ë‹¤ì›Œ.",
            "ë¯¸ì•ˆí•¨ë³´ë‹¤ íšŒë³µê³¼ ë°°ì›€ì— ì§‘ì¤‘í•˜ì.",
        ],
        "itgirl": [
            "ì˜¤ì¼€ì´ NG! ë‹¤ìŒ ì»·ì€ ì›í…Œì´í¬ë¡œ ê°€ì ğŸ’…",
            "í”ë“¤ë ¤ë„ ì¤‘ì‹¬ì€ ë‚˜. ì‹¤ìˆ˜ë„ ë‚´ ì„œì‚¬ì˜ ìŠ¤íŒŒí´.âœ¨",
            "í”„ë¡œëŠ” ë¹ ë¥¸ ë¦¬ì…‹. ì§€ê¸ˆì´ ë¦¬ë¶€íŠ¸ íƒ€ì´ë°.",
        ],
        "coach": [
            "ì‚¬ì‹¤ ì²´í¬â†’ë°°ìš´ ì  1ê°œâ†’ë‹¤ìŒ í–‰ë™ 1ê°œ. ë!",
            "í•„ìš”í•˜ë©´ ë°”ë¡œ ì‚¬ê³¼, ê·¸ë‹¤ìŒ ê°œì„  í”Œëœ.",
            "í•µì‹¬ ì›ì¸ 1ê°œë§Œ ê³ ì¹˜ê¸°(ê³¼ë¶€í•˜ ê¸ˆì§€).",
        ],
    },
    "relationship": {
        "warm": [
            "ë‚´ê°€ ì˜†ì—ì„œ ê°™ì´ ê±¸ì„ê²Œ. ë„¤ ì•ˆì˜ ìì‹ ê°ì´ ë„ˆë¥¼ ë” ë¹„ì¶°. âœ¨",
            "ë‚´ ë§ˆìŒì„ ë¨¼ì € ëŒë³´ì. ê±´ê°•í•œ ê²½ê³„ê°€ ë‹¤ì •í•¨ì„ ì§€ì¼œì¤˜.",
            "ìƒëŒ€ì˜ ê°ì •ì€ ë‚´ ì±…ì„ì´ ì•„ë‹ˆì•¼. ë‚œ ì§„ì‹¬ì´ë©´ ì¶©ë¶„í•´.",
            "ë§ì„ ê³ ë¥´ëŠ” ì‹œê°„ì€ ê´€ê³„ë¥¼ ì§€í‚¤ëŠ” ì‹œê°„.",
        ],
        "itgirl": [
            "ì¡´ì¤‘ì€ ê¸°ë³¸ê°’. ê¸°ì¤€ì— ëª» ë¯¸ì¹˜ë©´ ê±°ê¸°ê¹Œì§€.",
            "ë‚´ ì—ë„ˆì§€ëŠ” ì†Œì¤‘í•´. ê°€ì¹˜ ìˆëŠ” ê³³ì—ë§Œ ì“°ê¸°.",
            "ì„ ì„ ëª…í™•íˆ ê¸‹ëŠ” ê²Œ ê²°êµ­ ë” ë‹¤ì •í•´.",
        ],
        "coach": [
            "ìƒí™© 3ì¤„â†’ì›í•˜ëŠ” ê²°ê³¼ 1ì¤„â†’ë§í•  ë¬¸ì¥ 1ê°œ ì—°ìŠµ.",
            "â€˜ì–¸ì œ/ë¬´ì—‡/ì™œâ€™ í¬í•¨í•´ì„œ ìš”ì²­í•˜ê¸°.",
            "ëŒ€í™” ì‹œê°„ ì•½ì†â†’ì‚¬ì‹¤ë¶€í„° 5ë¶„ í•µì‹¬í† í¬.",
        ],
    },
    "challenge": {
        "warm": [
            "ë–¨ë¦¼ì€ ì•ìœ¼ë¡œ ë°€ì–´ì£¼ëŠ” ë°”ëŒì´ì•¼.",
            "ì‹œì‘í•œ ë„ˆ, ì´ë¯¸ ì ˆë°˜ì„ í•´ëƒˆì–´.",
            "ì§€ê¸ˆì˜ ìš©ê¸°ê°€ ë‚´ì¼ì˜ ìë‘ì´ ëœë‹¤.",
        ],
        "itgirl": [
            "ëª¨ë‘ ë‹¤ ê°€ì§€ë©´ ë˜ëŠ” ê±°ì•¼. í•˜ë‚˜ë§Œ ê³ ë¥¼í•„ìš” ì—†ì–´! ğŸ’…",
            "ë¬´ëŒ€ëŠ” ì¤€ë¹„ ì™„ë£Œ. ë“±ì¥ì€ ë‚˜ë‹µê²Œ ğŸ’–",
            "ë„ì „ì€ ë‚˜ë¥¼ ë¹„ì¶”ëŠ” ì¡°ëª…, ëˆˆë¶€ì‹œê²Œ ê°€ì.",
            "í¬ê²Œ ìˆ¨ ë“¤ì´ë§ˆì‹œê³ â€”ì£¼ì¸ê³µ ëª¨ë“œ ON.",
        ],
        "coach": [
            "ë¬´ë“œ ON: â€œë‚´ê°€ ì •í• ê²Œ ë‚˜ì˜ ë¬´ë“œ.â€",
            "ì—°ìŠµ 20ë¶„Ã—2ì„¸íŠ¸, ëë‚˜ë©´ ê°€ë²¼ìš´ ì‚°ì±….",
            "ë¦¬í—ˆì„¤ ì˜ìƒ 1íšŒâ†’ìê¸° í”¼ë“œë°± 3ê°œ.",
        ],
    },
    "procrastination": {
        "warm": [
            "ì•„ì£¼ ì‘ê²Œ ì‹œì‘í•˜ì. 2ë¶„ì´ë©´ ì¶©ë¶„í•´.",
            "ì™„ë²½ë³´ë‹¤ ì§„í–‰. í•œ ê±¸ìŒë„ ì•ìœ¼ë¡œ.",
            "ì˜¤ëŠ˜ì˜ ì‘ì€ ë£¨í‹´ì´ ë‚´ì¼ì˜ í¸ì•ˆí•¨.",
        ],
        "itgirl": [
            "ì„¸ìƒì— ë³´ë€ ë“¯ ë³´ì—¬ì¤˜; ë„Œ ì´ë¯¸ ëˆ„êµ¬ë³´ë‹¤ í™˜í•˜ê²Œ ë¹›ë‚˜ê±°ë“ .",
            "ë£¨í‹´ì€ ë‚˜ì˜ ì‹œê·¸ë‹ˆì²˜. íƒ€ì´ë¨¸ ìŠ¤íƒ€íŠ¸!",
            "ì§‘ì¤‘ì€ ìµœê³ ì˜ ì•¡ì„¸ì„œë¦¬.",
            "í•¸ë“œí° ë‚´ë ¤ë†“ê³ , ì£¼ì¸ê³µ ëª¨ë“œ ON.",
        ],
        "coach": [
            "2-5-10: 2ë¶„ ì •ë¦¬â†’5ë¶„ ê³„íšâ†’10ë¶„ ì‹¤í–‰.",
            "í•  ì¼ í•˜ë‚˜ë§Œ! ëë‚˜ë©´ ì…€í”„ ë³´ìƒ.",
            "ë°©í•´ìš”ì†Œ 3ê°œ ì°¨ë‹¨: ì•Œë¦¼/TV/ê°„ì‹.",
        ],
    },
}
GENERIC = {
    "warm": [
        "ë„¤ ì†ë„ë¡œ ê°€ë©´ ë¼. ì˜¤ëŠ˜ì˜ ë‚˜ë¥¼ ë‹¤ì •í•˜ê²Œ ì‘ì›í•´.",
        "ë§ˆìŒì´ ë§í•˜ëŠ” ê±¸ ë“¤ì—ˆì–´. í•¨ê»˜ ìˆ¨ ê³ ë¥´ì.",
    ],
    "itgirl": [
        "ì˜¤ëŠ˜ë„ ì£¼ì¸ê³µì€ ë‚˜. ê¸°ì¤€ì€ ë‚´ê°€ ë§Œë“ ë‹¤ ğŸ’–",
        "ë¹›ì€ ìŠ¤ìŠ¤ë¡œ ì¼œëŠ” ê²ƒ. ìŠ¤ìœ„ì¹˜ ON.",
    ],
    "coach": [
        "ëª©í‘œ 1ê°œë§Œ ê³ ë¥´ê³  10ë¶„ë§Œ ì‹¤í–‰!",
        "ê¸°ë¡â†’í”¼ë“œë°±â†’ë‹¤ìŒ í•œ ê±¸ìŒ. ë£¨í”„ë¥¼ ë¯¿ì.",
    ],
}
HASH_TAGS = ["#IVENISM", "#ItGirlEnergy", "#SelfLoveFirst", "#ë‚˜ë‹µê²Œ", "#ì˜¤ëŠ˜ì˜ì£¼ì¸ê³µ"]

def detect_intent(text: str):
    t = text.lower()
    for intent, keys in KEYWORDS.items():
        if any(k.lower() in t for k in keys): return intent
    return None

def generate_reply(text: str, tone: str):
    tone = tone if tone in TONES else "itgirl"
    intent = detect_intent(text)

    # ì˜ë„ë³„/í†¤ë³„ í’€ ì„ íƒ, ì—†ìœ¼ë©´ GENERIC ì‚¬ìš©
    if intent and tone in REPLIES[intent]:
        pool = REPLIES[intent][tone]
    else:
        pool = GENERIC[tone]

    # ë¦¬ìŠ¤íŠ¸ì˜ "ì²« ë¬¸ì¥"ì„ ìš°ì„  ì‚¬ìš© (ë¹„ì–´ìˆì„ ê²½ìš° ëŒ€ë¹„)
    first_line = next((s for s in pool if isinstance(s, str) and s.strip()), "")

    return f"{first_line} {random.choice(HASH_TAGS)}"


# ---------------- 2) Routes ----------------
@app.get("/")
def index():
    return render_template_string(HTML, now=datetime.utcnow().isoformat())

@app.post("/reply")
def reply():
    data = request.get_json(force=True) or {}
    text = (data.get("text") or "").strip()
    tone = (data.get("tone") or "itgirl").strip()
    if not text: return jsonify({"error": "empty text"}), 400
    return jsonify({"reply": generate_reply(text, tone), "time": datetime.utcnow().isoformat()})

# ---------------- 3) Frontend (High-contrast palette) ----------------
HTML = r"""<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>It-Girl Self-Love Diary</title>

<link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="preload" href="{{ url_for('static', filename='fonts/mongmong.ttf') }}?v=3" as="font" type="font/ttf" crossorigin>

<style>
@font-face{
  font-family:'MongmongDays';
  src:url('{{ url_for('static', filename='fonts/mongmong.ttf') }}?v=3') format('truetype');
  font-weight:400; font-style:normal; font-display:swap;
}

/* ===== Palette (ë” ë†’ì€ ëŒ€ë¹„) ===== */
:root{
  --ink:#2a1d22; --sub:#8e6d79;
  --pink:#ff8fb6;          /* ì½”ë„ í•‘í¬ */
  --pink-soft:#ffdbe8;     /* ì—°í•‘í¬ (ë°°ê²½ ì•…ì„¼íŠ¸) */
  --lav:#c9b7ff;           /* ë¼ì¼ë½ í¬ì¸íŠ¸ */
  --pearl:#fff7fb;         /* ì§„ì£¼ë¹› í™”ì´íŠ¸ */
  --case:#ffffff;          /* ë¶ ì¼€ì´ìŠ¤/ì¹´ë“œ í™”ì´íŠ¸ */
  --border:#ecd6de;
  --shadow:0 12px 36px rgba(30,20,30,.06), 0 18px 48px rgba(232,106,162,.16);
  --radius:20px;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:'SUIT',ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Helvetica,Arial;
  /* ë°°ê²½: í™”ì´íŠ¸/ì‚´êµ¬/ì—°í•‘í¬(ì•„ì£¼ ì˜…ê²Œ) */
  background:
    radial-gradient(1200px 900px at 15% -10%, #fffdfc, transparent 60%),
    radial-gradient(1400px 900px at 100% 0%, #fff2f6, transparent 60%),
    linear-gradient(180deg,#fffdfc 0%,#fff7f1 40%,#fff1f6 100%);
}
body::before{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
  background:
    radial-gradient(60% 80% at 50% 10%, rgba(255,255,255,.7), rgba(255,255,255,0) 70%),
    url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAG0lEQVQYV2NkwAIYGBgY/3+G4QZGRgYJgkQAAAH7wS1Yb2z9wAAAABJRU5ErkJggg==');
  mix-blend-mode:multiply; opacity:.45;
}
.wrap-bg{position:fixed; inset:0; z-index:-1; pointer-events:none;
  background:
    repeating-linear-gradient(180deg, rgba(255,170,210,.13) 0 1px, transparent 1px 32px),
    repeating-linear-gradient(90deg, rgba(200,170,210,.06) 0 1px, transparent 1px 28px);
  box-shadow: inset 0 0 140px rgba(255,126,182,.18);
}
.wrap{max-width:820px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column}

/* ===== COVER (ë°°ê²½ì€ í™”ì´íŠ¸, ì»¤ë²„ëŠ” í•‘í¬ë¡œ ëŒ€ë¹„) ===== */
.splash{position:fixed; inset:0; display:grid; place-items:center; z-index:9999;
  background:linear-gradient(180deg,#fff,#fff7fb);
}
.cover3d{width:min(92vw,760px); aspect-ratio:1.55/1; perspective:1800px}
.book{width:100%; height:100%; position:relative; transform-style:preserve-3d}
.ring{ position:absolute; left:calc(50% - 6px); top:0; bottom:0; width:12px;
  background:linear-gradient(90deg,#efe5ee,#ffdff0); box-shadow:inset 0 0 6px rgba(0,0,0,.06); border-radius:8px; }
.case, .cover{position:absolute; inset:0; border-radius:18px; transform-style:preserve-3d; box-shadow:0 30px 90px rgba(30,10,20,.08), 0 30px 90px rgba(232,106,162,.18)}
.case{background:linear-gradient(145deg,#ffffff,#f7f2f6); border:1px solid rgba(255,255,255,.95)}
.cover{width:50%; left:0; transform-origin:100% 50%;
  background:linear-gradient(135deg,#ffd2e5,#ff8fb6); /* ì—°í•‘í¬â†’ì½”ë„í•‘í¬ */
  border:1px solid rgba(255,255,255,.95)}
.frame{position:absolute; inset:18px; border-radius:16px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.95), inset 0 -1px 0 rgba(220,180,195,.55),
              inset 1px 0 0 rgba(255,255,255,.95), inset -1px 0 0 rgba(220,180,195,.55) }
.cover-title{position:absolute; top:16%; left:50%; transform:translateX(-50%);
  font-family:'MongmongDays','SUIT',ui-sans-serif; font-weight:400; font-size:36px; color:#e14f98;
  text-shadow:0 8px 18px rgba(225,79,152,.35)}
.heart-window{position:absolute; left:50%; top:48%; transform:translate(-50%,-50%); width:46%; aspect-ratio:1/1; filter: drop-shadow(0 14px 28px rgba(232,106,162,.25))}
.heart-window svg{width:100%; height:100%}
.heart-fill{fill:url(#heartGrad); filter: drop-shadow(0 2px 0 rgba(255,255,255,.85)) drop-shadow(0 -2px 0 rgba(220,176,192,.5))}
.wing{fill:url(#wingGrad); opacity:.95; filter:drop-shadow(0 6px 10px rgba(232,106,162,.18))}
.open-btn{position:absolute; bottom:20px; right:20px; padding:10px 14px; border-radius:14px; border:1px solid #ead4dd;
  background:linear-gradient(90deg,#ff8fb6,#ffbdd3); color:#fff; font-weight:700; box-shadow:0 10px 26px rgba(232,106,162,.22); cursor:pointer}
.hint{position:absolute; bottom:22px; left:22px; color:#8e6d79; font-size:12px}
.opening .cover{ animation:flip 1.15s ease forwards } @keyframes flip{ 0%{transform:rotateY(0)} 100%{transform:rotateY(-165deg)} }
.splash.hide{ animation:fadeOut .45s ease forwards; pointer-events:none } @keyframes fadeOut{to{opacity:0; visibility:hidden}}

/* ===== PARTICLES (í™”ì´íŠ¸/í„/ë¼ì¼ë½ + ì–‡ì€ ìŠ¤íŠ¸ë¡œí¬) ===== */
.particles{ position:fixed; inset:0; pointer-events:none; z-index:5; overflow:hidden }
.particle{ position:absolute; opacity:0; animation: floatUp linear forwards, twinkle ease-in-out infinite }
@keyframes floatUp {
  from { transform: translateY(20vh) scale(.85) rotate(0deg); opacity:0 }
  10% { opacity:.95 }
  to { transform: translateY(-110vh) scale(1.05) rotate(80deg); opacity:0 }
}
@keyframes twinkle { 0%,100%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)) } 50%{ filter: drop-shadow(0 0 12px rgba(210,190,255,.65)) } }

/* ===== APP UI (ë” í™”ì´íŠ¸ ì¤‘ì‹¬) ===== */
header{position:sticky; top:0; z-index:10; backdrop-filter:blur(8px)}
.hero{margin:12px 16px 4px; padding:18px 16px;
  background:linear-gradient(135deg,#ffffff,#fff7fb 50%,#ffeef6);
  border:1px solid var(--border); border-radius:calc(var(--radius)+6px); box-shadow:var(--shadow);
  display:flex; align-items:center; gap:14px}
.hero .emoji{font-size:30px}
.hero .title{font-family:'MongmongDays','SUIT',ui-sans-serif; font-weight:400; font-size:22px; letter-spacing:.2px}
.hero small{color:var(--sub)}
.topbar{display:flex; justify-content:space-between; align-items:center; padding:8px 16px 12px}

.btn{border:1px solid var(--border); background:#fff; color:var(--ink); padding:9px 12px; border-radius:14px; box-shadow:var(--shadow); font-size:14px; font-weight:700}
.btn-primary{background:linear-gradient(90deg,#7f79ff,#bfa9ff); color:#fff; border-color:transparent} /* ë¼ì¼ë½ í¬ì¸íŠ¸ */

.tone{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; padding:8px 16px 4px}
.tone button{font-family:'MongmongDays','SUIT',ui-sans-serif; padding:10px 12px; border-radius:18px;
  border:1px solid var(--border); background:#fff; color:#6a5660; box-shadow:var(--shadow)}
.tone button.active{background:linear-gradient(90deg,#ff9ec9,#ffd6e8); color:#fff; border-color:transparent}

.presets{display:flex; gap:8px; overflow:auto; padding:6px 16px 10px}
.chip{font-family:'MongmongDays','SUIT',ui-sans-serif; border:1px solid #ead4dd; background:#ffffff; color:#6a5660;
  padding:8px 12px; border-radius:999px; white-space:nowrap; font-weight:700; box-shadow:0 10px 22px rgba(30,20,30,.04)}

main{flex:1; padding:12px 16px}
.list{display:flex; flex-direction:column; gap:12px}
.paper{
  background:linear-gradient(180deg,#ffffff,#fffafc), repeating-linear-gradient(180deg, rgba(210,160,200,.16) 0 1px, transparent 1px 32px);
  border:1px solid #ead4dd; border-radius:22px; padding:16px; box-shadow:0 14px 40px rgba(30,10,20,.06)
}
.bubble{max-width:86%; padding:12px 14px; border-radius:18px; border:1px solid #ead4dd; background:#fff; box-shadow:0 10px 26px rgba(0,0,0,.04); font-family:'SUIT',ui-sans-serif}
.bubble.me{margin-left:auto}
.bubble.ive{
  background:linear-gradient(135deg,#c9b7ff,#ffb7d4); /* ë¼ì¼ë½â†’í•‘í¬ */
  color:#fff; border-color:transparent; position:relative;
  font-family:'MongmongDays','SUIT',ui-sans-serif; font-size:16px
}
.bubble.ive:after{content:""; position:absolute; inset:-1px; border-radius:18px; background:linear-gradient(180deg,rgba(255,255,255,.25),transparent 60%); pointer-events:none; mix-blend-mode:screen}
.meta{margin-top:6px; font-size:10px; color:var(--sub)}

footer{padding:8px 16px 18px}
.composer{display:flex; gap:10px; background:#fff; border:1px solid #ead4dd; border-radius:22px; padding:10px; box-shadow:0 10px 28px rgba(30,10,20,.06)}
textarea{flex:1; resize:none; background:#fffdfd; border:0; outline:0; border-radius:14px; min-height:82px; padding:10px 12px; font-size:14px; font-family:'MongmongDays','SUIT',ui-sans-serif}
.hint{color:var(--sub); font-size:11px; margin-top:6px}
.small{color:var(--sub); font-size:11px; padding:8px 16px 16px}
</style>
</head>
<body>
<div class="wrap-bg"></div>

<!-- Particles -->
<div class="particles" id="particles"></div>

<!-- COVER -->
<div class="splash" id="splash">
  <div class="cover3d">
    <div class="book" id="book">
      <div class="case"></div>
      <div class="ring"></div>

      <div class="cover">
        <div class="frame"></div>
        <div class="cover-title">I(LO)VEMEğŸ’— Diary</div>
        <div class="heart-window">
          <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="heartGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#ffd4e7"/>
                <stop offset="100%" stop-color="#ff8fb6"/>
              </linearGradient>
              <linearGradient id="wingGrad" x1="0" x2="1" y1="0" y2="0">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#f2ecff"/>
              </linearGradient>
              <clipPath id="heartClip">
                <path d="M100,75 C85,60 55,47 55,30 C55,17 66,10 76,10 C86,10 95,16 100,25
                        C105,16 114,10 124,10 C134,10 145,17 145,30 C145,47 115,60 100,75 Z"/>
              </clipPath>
            </defs>

            <path class="wing" d="M55,45 c-18,-6 -30,-2 -36,3 c8,0 16,2 24,6 c-8,0 -14,3 -19,7
                                   c9,-1 16,1 23,4 c-6,1 -10,4 -12,7 c8,-2 15,0 21,2 c-5,2 -8,4 -9,7
                                   c7,-2 13,-1 18,1" fill="url(#wingGrad)" stroke="#eae3ff" stroke-width="0.6"/>
            <path class="wing" d="M145,45 c18,-6 30,-2 36,3 c-8,0 -16,2 -24,6 c8,0 14,3 19,7
                                   c-9,-1 -16,1 -23,4 c6,1 10,4 12,7 c-8,-2 -15,0 -21,2 c5,2 8,4 9,7
                                   c-7,-2 -13,-1 -18,1" fill="url(#wingGrad)" stroke="#eae3ff" stroke-width="0.6"/>
            <g clip-path="url(#heartClip)">
              <rect x="45" y="5" width="110" height="90" class="heart-fill"/>
              <ellipse cx="92" cy="26" rx="18" ry="10" fill="rgba(255,255,255,.55)"/>
            </g>
            <path d="M100,75 C85,60 55,47 55,30 C55,17 66,10 76,10 C86,10 95,16 100,25
                     C105,16 114,10 124,10 C134,10 145,17 145,30 C145,47 115,60 100,75 Z"
                  fill="none" stroke="#e6dfe6" stroke-width="4"/>
          </svg>
        </div>
        <button class="open-btn" id="openDiary">ì—´ê¸°</button>
        <div class="hint">ë‹¤ì´ì–´ë¦¬ ì“°ê¸°!</div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="visibility:hidden">
  <header>
    <div class="hero">
      <div class="emoji">ğŸ©°</div>
      <div>
        <div class="title">I(LO)VEMEğŸ’— Diary</div>
        <small>IVEê°€ ë“¤ì–´ì¤„ê²Œ! TeLL Me Your Secret!</small>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn" id="copyLast">ì‘ì› ë³µì‚¬</button>
        <button class="btn" id="showCover">í‘œì§€ ë‹¤ì‹œ ë³´ê¸°</button>
      </div>
    </div>

    <div class="topbar">
      <div style="display:flex; gap:8px;">
        <button class="btn" id="export">ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn" id="clear">ëª¨ë‘ ì‚­ì œ</button>
      </div>
      <button class="btn btn-primary" id="scrollBottom">â¬‡ ëŒ€í™” ë§¨ì•„ë˜</button>
    </div>
  </header>

  <section class="tone">
    <button data-tone="warm">ğŸ’— IVE ì›…ë‹ˆ</button>
    <button data-tone="itgirl" class="active">ğŸ€ Itgirl VIBE</button>
    <button data-tone="coach">ğŸ¯ ì½”ì¹˜ëª¨ë“œ!</button>
  </section>

  <div class="presets" id="presets"></div>

  <main>
    <div class="paper">
      <div class="list" id="list"></div>
    </div>
  </main>

  <footer>
    <div class="composer">
      <textarea id="input" placeholder="ì˜¤ëŠ˜ì˜ ë§ˆìŒì„ ì•Œë ¤ì¤˜! ë‚˜ë§Œ ì•Œê³ ìˆì„ê²Œ!âœï¸"></textarea>
      <button class="btn btn-primary" id="send">ë³´ë‚´ê¸°</button>
    </div>
    <div class="hint">ë¡œì»¬ ì €ì¥: ì´ í˜ì´ì§€ì˜ ê¸°ë¡ì€ ì´ ê¸°ê¸°(localStorage)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
  </footer>

  <div class="small">server time: {{ now }}</div>
</div>

<script>
/* Cover open/close */
const KEY="ive-cover-seen";
const splash=document.getElementById('splash');
const app=document.getElementById('app');
const openBtn=document.getElementById('openDiary');
const showCover=document.getElementById('showCover');
function openBook(){ document.querySelector('.cover3d').classList.add('opening'); setTimeout(()=>{ splash.classList.add('hide'); app.style.visibility='visible'; localStorage.setItem(KEY,'1'); }, 1200); }
function showBook(){ splash.classList.remove('hide'); app.style.visibility='hidden'; document.querySelector('.cover3d').classList.remove('opening'); }
if(localStorage.getItem(KEY)==='1'){ splash.classList.add('hide'); app.style.visibility='visible'; }
openBtn.addEventListener('click', openBook);
showCover.addEventListener('click', ()=>{ localStorage.removeItem(KEY); showBook(); });

/* Particles: white/pearl/lilac + subtle stroke */
const particles = document.getElementById('particles');
const svgs = [
  // heart (white stroke)
  `<svg viewBox="0 0 40 36" xmlns="http://www.w3.org/2000/svg">
     <defs><linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
       <stop offset="0%" stop-color="#fff8fd"/><stop offset="100%" stop-color="#ffe7f2"/></linearGradient></defs>
     <path d="M20,32 C9,24 2,19 2,11 C2,6 6,3 10,3 c4,0 7,2 10,6 c3,-4 6,-6 10,-6 c4,0 8,3 8,8 c0,8 -7,13 -18,21 z"
           fill="url(#g1)" stroke="#ffffff" stroke-width="0.6" />
   </svg>`,
  // ribbon (pearl white)
  `<svg viewBox="0 0 60 36" xmlns="http://www.w3.org/2000/svg">
     <linearGradient id="g2" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#f5f0ff"/></linearGradient>
     <path d="M30 18c8-6 18-10 26-10-5 6-10 12-16 18-4 4-7 6-10 4-3 2-6 0-10-4C14 20 9 14 4 8c8 0 18 4 26 10z"
           fill="url(#g2)" opacity=".95" stroke="#ffffff" stroke-width="0.5"/>
     <circle cx="30" cy="18" r="4" fill="#fff0fa" stroke="#ffffff" stroke-width="0.4"/>
   </svg>`,
  // pearl (lilac glow)
  `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
     <radialGradient id="g3" cx="50%" cy="40%" r="60%">
       <stop offset="0%" stop-color="#ffffff"/><stop offset="60%" stop-color="#f6f1ff"/><stop offset="100%" stop-color="#e8dbff"/></radialGradient>
     <circle cx="12" cy="12" r="8" fill="url(#g3)" stroke="#ffffff" stroke-width="0.5"/>
   </svg>`
];
function spawn() {
  const el = document.createElement('div');
  el.className = 'particle';
  el.innerHTML = svgs[Math.floor(Math.random()*svgs.length)];
  const size = 16 + Math.random()*28;
  el.style.left = Math.random()*100 + 'vw';
  el.style.bottom = (-10 + Math.random()*20) + 'vh';
  el.style.width = size + 'px';
  const dur = 18 + Math.random()*16;
  el.style.animationDuration = dur + 's, ' + (3 + Math.random()*3) + 's';
  el.style.animationDelay = (Math.random()*8) + 's, 0s';
  particles.appendChild(el);
  setTimeout(()=>el.remove(), (dur+1)*1000);
}
for(let i=0;i<20;i++) spawn();
setInterval(()=>spawn(), 1800);

/* App logic */
const LS="ive-diary-contrast-v1";
const $=(s)=>document.querySelector(s);
const listEl=$("#list"), inputEl=$("#input");
const sendBtn=$("#send"), exportBtn=$("#export"), clearBtn=$("#clear");
const copyBtn=$("#copyLast"), sbBtn=$("#scrollBottom");
const toneBtns=document.querySelectorAll(".tone button");
const presetsEl=$("#presets");

const presets=[
  "ë‚˜ ì˜¤ëŠ˜ í˜ë“¤ì—ˆì–´. ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œ?",
  "ìš”ì¦˜ ìì‹ ê°ì´ ë–¨ì–´ì§€ëŠ” ëŠë‚Œì´ì•¼.",
  "ì‹¤ìˆ˜ë¥¼ í•´ì„œ ë„ˆë¬´ ì†ìƒí•´.",
  "ì‚¬ëŒ ê´€ê³„ê°€ ì–´ë ¤ì›Œâ€¦",
  "ìƒˆë¡œìš´ ë„ì „ ì•ì´ë¼ ë–¨ë ¤.",
  "ë¯¸ë£¨ê²Œ ë¼ì„œ ë£¨í‹´ì„ ë§Œë“¤ê³  ì‹¶ì–´.",
];

let tone="itgirl"; let entries=[];
try{ entries=JSON.parse(localStorage.getItem(LS)||"[]"); }catch(e){ entries=[]; }

presets.forEach(p=>{ const b=document.createElement("button"); b.className="chip"; b.textContent=p; b.onclick=()=>sendMessage(p); presetsEl.appendChild(b); });
toneBtns.forEach(btn=>btn.addEventListener("click",()=>{ toneBtns.forEach(b=>b.classList.remove("active")); btn.classList.add("active"); tone=btn.dataset.tone; }));

function render(){
  listEl.innerHTML="";
  entries.forEach(item=>{
    const div=document.createElement("div");
    div.className="bubble "+(item.role==="user"?"me":"ive");
    div.textContent=item.text;
    const meta=document.createElement("div");
    meta.className="meta";
    meta.textContent=(item.role==="user"?"ë‚˜ì˜ ê¸°ë¡ Â· ":"IVE ì‘ì› Â· ")+new Date(item.time).toLocaleString();
    div.appendChild(meta);
    listEl.appendChild(div);
  });
  listEl.scrollTop=999999;
  localStorage.setItem(LS, JSON.stringify(entries));
}
render();

async function sendMessage(text){
  const content=(text ?? inputEl.value).trim();
  if(!content) return;
  const now=new Date().toISOString();
  entries.push({role:"user", text:content, time:now, tone}); render(); inputEl.value="";
  try{
    const res=await fetch("/reply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:content,tone})});
    const data=await res.json();
    if(data?.reply){ entries.push({role:"ive", text:data.reply, time:data.time, tone}); render(); }
  }catch(e){
    entries.push({role:"ive", text:"ì„œë²„ ì—°ê²°ì— ì ì‹œ ë¬¸ì œê°€ ìˆì–´ìš”. ê³§ ë‹¤ì‹œ ì‹œë„í•´ì¤˜ ğŸ’—", time:new Date().toISOString(), tone}); render();
  }
}

sendBtn.addEventListener("click", ()=>sendMessage());
inputEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
exportBtn?.addEventListener("click", ()=>{ const blob=new Blob([JSON.stringify(entries,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="ive-diary.json"; a.click(); URL.revokeObjectURL(url); });
clearBtn?.addEventListener("click", ()=>{ if(confirm("ëª¨ë“  ëŒ€í™”ë¥¼ ì‚­ì œí• ê¹Œìš”?")){ entries=[]; render(); }});
copyBtn?.addEventListener("click", ()=>{ const last=[...entries].reverse().find(e=>e.role==="ive"); if(!last) return; navigator.clipboard.writeText(last.text).then(()=>alert("ë§ˆì§€ë§‰ ì‘ì›ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆì–´ìš” ğŸ’–")); });
sbBtn?.addEventListener("click", ()=>{ listEl.scrollTop=999999; });
</script>
</body>
</html>
"""

# ---------------- 4) Run ----------------
if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--host", default="127.0.0.1")
    parser.add_argument("--port", default=5000, type=int)
    args = parser.parse_args()
    app.run(host=args.host, port=args.port, debug=True)
