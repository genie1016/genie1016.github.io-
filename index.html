# app.py
# It-Girl Self-Love Diary — High-Contrast Pastel (White/Pink/Lilac) + Heart Cover + SVG Particles

from flask import Flask, request, jsonify, render_template_string, url_for
from datetime import datetime
import argparse, random

app = Flask(__name__, static_folder="static")

# ---------------- 1) Reply logic (그대로) ----------------
KEYWORDS = {
    "stress": ["힘들", "지쳤", "번아웃", "피곤", "스트레스"],
    "selfDoubt": ["불안", "자신", "자존감", "걱정", "초조"],
    "mistake": ["실수", "망했", "후회", "창피", "민망"],
    "relationship": ["친구", "연애", "관계", "팀", "회사"],
    "challenge": ["도전", "새로운", "시작", "면접", "시험"],
    "procrastination": ["미루", "게으", "집중", "루틴", "습관"],
}
TONES = ["warm", "itgirl", "coach"]
REPLIES = {
    "stress": {
        "warm": [
            "부딪히는 날도 있지. 그래도 행운은 늘 네 편이래.🍀",
            "오늘 수고했어. 따뜻한 차 한 잔처럼 마음을 덮어주자.",
            "판단은 내일에게 맡기자. 지금은 쉬어도 충분히 가치 있어.",
            "숨을 깊게 쉬고 어깨 편 다음, 오늘의 나를 꼭 안아줘.",
        ],
        "itgirl": [
            "오늘 무드는 네가 정해! 다른 사람이 뭐라 해도 넌 너라서 충분해.  ",
            "스트레스? 난 루틴으로 컨트롤해. 물 마시고 스트레칭 1분, 리셋!",
            "바쁠수록 더 빛나는 무드. 오늘도 주인공은 나야 ✨",
            "내 페이스는 내가 정해. 천천히 가도 꾸준히 쌓여.",
        ],
        "coach": [
            "“난 나일 때 가장 빛나.” 따라갈 필요 없어—넌 너의 길로. 🚀",
            "10분 회복 루틴: 물→스트레칭→창 밖 보기. 그다음 한 가지만 처리.",
            "할 일 3개로 줄이기. 작은 승리부터 쌓자.",
            "피곤지수 1~5 기록. 4 이상이면 회복 먼저!",
        ],
    },
    "selfDoubt": {
        "warm": [
            "난 나일 때 가장 빛나!✨ 잊지 말고, 길을 잃어도 괜찮아.",
            "불안해도 괜찮아. 네 가치는 흔들리지 않아.",
            "오늘의 나도 충분히 예쁘고 단단해.",
            "걱정의 크기보다, 내가 해낸 것의 목록을 더 크게 쓰자.",
        ],
        "itgirl": [
            "무드는 내가 정해. 남 눈치 NO—끌리지 않는 것엔 안 끌려.",
            "거울 보기. 이미 ‘베스트 버전’ 갱신 중 💖",
            "기준은 내가 만든다. 오늘도 자기확신 ON.",
            "비교는 OFF, 나다움은 MAX.",
        ],
        "coach": [
            "자신감 루틴: 거울 앞에서 “누구보다도 먼저 나를 믿어” 3회!",
            "증거 3가지 적기: 해낸 일, 받은 칭찬, 버틴 순간.",
            "24시간 비교 금지 챌린지 시작!",
            "불안 한 줄 → 반박 한 줄. 균형 잡기.",
        ],
    },
    "mistake": {
        "warm": [
            "실수는 성장의 이정표야. 오늘은 다정하게 넘어가자.",
            "하루의 한 장면일 뿐, 전체 서사는 충분히 아름다워.",
            "미안함보다 회복과 배움에 집중하자.",
        ],
        "itgirl": [
            "오케이 NG! 다음 컷은 원테이크로 가자 💅",
            "흔들려도 중심은 나. 실수도 내 서사의 스파클.✨",
            "프로는 빠른 리셋. 지금이 리부트 타이밍.",
        ],
        "coach": [
            "사실 체크→배운 점 1개→다음 행동 1개. 끝!",
            "필요하면 바로 사과, 그다음 개선 플랜.",
            "핵심 원인 1개만 고치기(과부하 금지).",
        ],
    },
    "relationship": {
        "warm": [
            "내가 옆에서 같이 걸을게. 네 안의 자신감이 너를 더 비춰. ✨",
            "내 마음을 먼저 돌보자. 건강한 경계가 다정함을 지켜줘.",
            "상대의 감정은 내 책임이 아니야. 난 진심이면 충분해.",
            "말을 고르는 시간은 관계를 지키는 시간.",
        ],
        "itgirl": [
            "존중은 기본값. 기준에 못 미치면 거기까지.",
            "내 에너지는 소중해. 가치 있는 곳에만 쓰기.",
            "선을 명확히 긋는 게 결국 더 다정해.",
        ],
        "coach": [
            "상황 3줄→원하는 결과 1줄→말할 문장 1개 연습.",
            "‘언제/무엇/왜’ 포함해서 요청하기.",
            "대화 시간 약속→사실부터 5분 핵심토크.",
        ],
    },
    "challenge": {
        "warm": [
            "떨림은 앞으로 밀어주는 바람이야.",
            "시작한 너, 이미 절반을 해냈어.",
            "지금의 용기가 내일의 자랑이 된다.",
        ],
        "itgirl": [
            "모두 다 가지면 되는 거야. 하나만 고를필요 없어! 💅",
            "무대는 준비 완료. 등장은 나답게 💖",
            "도전은 나를 비추는 조명, 눈부시게 가자.",
            "크게 숨 들이마시고—주인공 모드 ON.",
        ],
        "coach": [
            "무드 ON: “내가 정할게 나의 무드.”",
            "연습 20분×2세트, 끝나면 가벼운 산책.",
            "리허설 영상 1회→자기 피드백 3개.",
        ],
    },
    "procrastination": {
        "warm": [
            "아주 작게 시작하자. 2분이면 충분해.",
            "완벽보다 진행. 한 걸음도 앞으로.",
            "오늘의 작은 루틴이 내일의 편안함.",
        ],
        "itgirl": [
            "세상에 보란 듯 보여줘; 넌 이미 누구보다 환하게 빛나거든.",
            "루틴은 나의 시그니처. 타이머 스타트!",
            "집중은 최고의 액세서리.",
            "핸드폰 내려놓고, 주인공 모드 ON.",
        ],
        "coach": [
            "2-5-10: 2분 정리→5분 계획→10분 실행.",
            "할 일 하나만! 끝나면 셀프 보상.",
            "방해요소 3개 차단: 알림/TV/간식.",
        ],
    },
}
GENERIC = {
    "warm": [
        "네 속도로 가면 돼. 오늘의 나를 다정하게 응원해.",
        "마음이 말하는 걸 들었어. 함께 숨 고르자.",
    ],
    "itgirl": [
        "오늘도 주인공은 나. 기준은 내가 만든다 💖",
        "빛은 스스로 켜는 것. 스위치 ON.",
    ],
    "coach": [
        "목표 1개만 고르고 10분만 실행!",
        "기록→피드백→다음 한 걸음. 루프를 믿자.",
    ],
}
HASH_TAGS = ["#IVENISM", "#ItGirlEnergy", "#SelfLoveFirst", "#나답게", "#오늘의주인공"]

def detect_intent(text: str):
    t = text.lower()
    for intent, keys in KEYWORDS.items():
        if any(k.lower() in t for k in keys): return intent
    return None

def generate_reply(text: str, tone: str):
    tone = tone if tone in TONES else "itgirl"
    intent = detect_intent(text)

    # 의도별/톤별 풀 선택, 없으면 GENERIC 사용
    if intent and tone in REPLIES[intent]:
        pool = REPLIES[intent][tone]
    else:
        pool = GENERIC[tone]

    # 리스트의 "첫 문장"을 우선 사용 (비어있을 경우 대비)
    first_line = next((s for s in pool if isinstance(s, str) and s.strip()), "")

    return f"{first_line} {random.choice(HASH_TAGS)}"


# ---------------- 2) Routes ----------------
@app.get("/")
def index():
    return render_template_string(HTML, now=datetime.utcnow().isoformat())

@app.post("/reply")
def reply():
    data = request.get_json(force=True) or {}
    text = (data.get("text") or "").strip()
    tone = (data.get("tone") or "itgirl").strip()
    if not text: return jsonify({"error": "empty text"}), 400
    return jsonify({"reply": generate_reply(text, tone), "time": datetime.utcnow().isoformat()})

# ---------------- 3) Frontend (High-contrast palette) ----------------
HTML = r"""<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>It-Girl Self-Love Diary</title>

<link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="preload" href="{{ url_for('static', filename='fonts/mongmong.ttf') }}?v=3" as="font" type="font/ttf" crossorigin>

<style>
@font-face{
  font-family:'MongmongDays';
  src:url('{{ url_for('static', filename='fonts/mongmong.ttf') }}?v=3') format('truetype');
  font-weight:400; font-style:normal; font-display:swap;
}

/* ===== Palette (더 높은 대비) ===== */
:root{
  --ink:#2a1d22; --sub:#8e6d79;
  --pink:#ff8fb6;          /* 코랄 핑크 */
  --pink-soft:#ffdbe8;     /* 연핑크 (배경 악센트) */
  --lav:#c9b7ff;           /* 라일락 포인트 */
  --pearl:#fff7fb;         /* 진주빛 화이트 */
  --case:#ffffff;          /* 북 케이스/카드 화이트 */
  --border:#ecd6de;
  --shadow:0 12px 36px rgba(30,20,30,.06), 0 18px 48px rgba(232,106,162,.16);
  --radius:20px;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:'SUIT',ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Helvetica,Arial;
  /* 배경: 화이트/살구/연핑크(아주 옅게) */
  background:
    radial-gradient(1200px 900px at 15% -10%, #fffdfc, transparent 60%),
    radial-gradient(1400px 900px at 100% 0%, #fff2f6, transparent 60%),
    linear-gradient(180deg,#fffdfc 0%,#fff7f1 40%,#fff1f6 100%);
}
body::before{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
  background:
    radial-gradient(60% 80% at 50% 10%, rgba(255,255,255,.7), rgba(255,255,255,0) 70%),
    url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAG0lEQVQYV2NkwAIYGBgY/3+G4QZGRgYJgkQAAAH7wS1Yb2z9wAAAABJRU5ErkJggg==');
  mix-blend-mode:multiply; opacity:.45;
}
.wrap-bg{position:fixed; inset:0; z-index:-1; pointer-events:none;
  background:
    repeating-linear-gradient(180deg, rgba(255,170,210,.13) 0 1px, transparent 1px 32px),
    repeating-linear-gradient(90deg, rgba(200,170,210,.06) 0 1px, transparent 1px 28px);
  box-shadow: inset 0 0 140px rgba(255,126,182,.18);
}
.wrap{max-width:820px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column}

/* ===== COVER (배경은 화이트, 커버는 핑크로 대비) ===== */
.splash{position:fixed; inset:0; display:grid; place-items:center; z-index:9999;
  background:linear-gradient(180deg,#fff,#fff7fb);
}
.cover3d{width:min(92vw,760px); aspect-ratio:1.55/1; perspective:1800px}
.book{width:100%; height:100%; position:relative; transform-style:preserve-3d}
.ring{ position:absolute; left:calc(50% - 6px); top:0; bottom:0; width:12px;
  background:linear-gradient(90deg,#efe5ee,#ffdff0); box-shadow:inset 0 0 6px rgba(0,0,0,.06); border-radius:8px; }
.case, .cover{position:absolute; inset:0; border-radius:18px; transform-style:preserve-3d; box-shadow:0 30px 90px rgba(30,10,20,.08), 0 30px 90px rgba(232,106,162,.18)}
.case{background:linear-gradient(145deg,#ffffff,#f7f2f6); border:1px solid rgba(255,255,255,.95)}
.cover{width:50%; left:0; transform-origin:100% 50%;
  background:linear-gradient(135deg,#ffd2e5,#ff8fb6); /* 연핑크→코랄핑크 */
  border:1px solid rgba(255,255,255,.95)}
.frame{position:absolute; inset:18px; border-radius:16px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.95), inset 0 -1px 0 rgba(220,180,195,.55),
              inset 1px 0 0 rgba(255,255,255,.95), inset -1px 0 0 rgba(220,180,195,.55) }
.cover-title{position:absolute; top:16%; left:50%; transform:translateX(-50%);
  font-family:'MongmongDays','SUIT',ui-sans-serif; font-weight:400; font-size:36px; color:#e14f98;
  text-shadow:0 8px 18px rgba(225,79,152,.35)}
.heart-window{position:absolute; left:50%; top:48%; transform:translate(-50%,-50%); width:46%; aspect-ratio:1/1; filter: drop-shadow(0 14px 28px rgba(232,106,162,.25))}
.heart-window svg{width:100%; height:100%}
.heart-fill{fill:url(#heartGrad); filter: drop-shadow(0 2px 0 rgba(255,255,255,.85)) drop-shadow(0 -2px 0 rgba(220,176,192,.5))}
.wing{fill:url(#wingGrad); opacity:.95; filter:drop-shadow(0 6px 10px rgba(232,106,162,.18))}
.open-btn{position:absolute; bottom:20px; right:20px; padding:10px 14px; border-radius:14px; border:1px solid #ead4dd;
  background:linear-gradient(90deg,#ff8fb6,#ffbdd3); color:#fff; font-weight:700; box-shadow:0 10px 26px rgba(232,106,162,.22); cursor:pointer}
.hint{position:absolute; bottom:22px; left:22px; color:#8e6d79; font-size:12px}
.opening .cover{ animation:flip 1.15s ease forwards } @keyframes flip{ 0%{transform:rotateY(0)} 100%{transform:rotateY(-165deg)} }
.splash.hide{ animation:fadeOut .45s ease forwards; pointer-events:none } @keyframes fadeOut{to{opacity:0; visibility:hidden}}

/* ===== PARTICLES (화이트/펄/라일락 + 얇은 스트로크) ===== */
.particles{ position:fixed; inset:0; pointer-events:none; z-index:5; overflow:hidden }
.particle{ position:absolute; opacity:0; animation: floatUp linear forwards, twinkle ease-in-out infinite }
@keyframes floatUp {
  from { transform: translateY(20vh) scale(.85) rotate(0deg); opacity:0 }
  10% { opacity:.95 }
  to { transform: translateY(-110vh) scale(1.05) rotate(80deg); opacity:0 }
}
@keyframes twinkle { 0%,100%{ filter: drop-shadow(0 0 0 rgba(255,255,255,0)) } 50%{ filter: drop-shadow(0 0 12px rgba(210,190,255,.65)) } }

/* ===== APP UI (더 화이트 중심) ===== */
header{position:sticky; top:0; z-index:10; backdrop-filter:blur(8px)}
.hero{margin:12px 16px 4px; padding:18px 16px;
  background:linear-gradient(135deg,#ffffff,#fff7fb 50%,#ffeef6);
  border:1px solid var(--border); border-radius:calc(var(--radius)+6px); box-shadow:var(--shadow);
  display:flex; align-items:center; gap:14px}
.hero .emoji{font-size:30px}
.hero .title{font-family:'MongmongDays','SUIT',ui-sans-serif; font-weight:400; font-size:22px; letter-spacing:.2px}
.hero small{color:var(--sub)}
.topbar{display:flex; justify-content:space-between; align-items:center; padding:8px 16px 12px}

.btn{border:1px solid var(--border); background:#fff; color:var(--ink); padding:9px 12px; border-radius:14px; box-shadow:var(--shadow); font-size:14px; font-weight:700}
.btn-primary{background:linear-gradient(90deg,#7f79ff,#bfa9ff); color:#fff; border-color:transparent} /* 라일락 포인트 */

.tone{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; padding:8px 16px 4px}
.tone button{font-family:'MongmongDays','SUIT',ui-sans-serif; padding:10px 12px; border-radius:18px;
  border:1px solid var(--border); background:#fff; color:#6a5660; box-shadow:var(--shadow)}
.tone button.active{background:linear-gradient(90deg,#ff9ec9,#ffd6e8); color:#fff; border-color:transparent}

.presets{display:flex; gap:8px; overflow:auto; padding:6px 16px 10px}
.chip{font-family:'MongmongDays','SUIT',ui-sans-serif; border:1px solid #ead4dd; background:#ffffff; color:#6a5660;
  padding:8px 12px; border-radius:999px; white-space:nowrap; font-weight:700; box-shadow:0 10px 22px rgba(30,20,30,.04)}

main{flex:1; padding:12px 16px}
.list{display:flex; flex-direction:column; gap:12px}
.paper{
  background:linear-gradient(180deg,#ffffff,#fffafc), repeating-linear-gradient(180deg, rgba(210,160,200,.16) 0 1px, transparent 1px 32px);
  border:1px solid #ead4dd; border-radius:22px; padding:16px; box-shadow:0 14px 40px rgba(30,10,20,.06)
}
.bubble{max-width:86%; padding:12px 14px; border-radius:18px; border:1px solid #ead4dd; background:#fff; box-shadow:0 10px 26px rgba(0,0,0,.04); font-family:'SUIT',ui-sans-serif}
.bubble.me{margin-left:auto}
.bubble.ive{
  background:linear-gradient(135deg,#c9b7ff,#ffb7d4); /* 라일락→핑크 */
  color:#fff; border-color:transparent; position:relative;
  font-family:'MongmongDays','SUIT',ui-sans-serif; font-size:16px
}
.bubble.ive:after{content:""; position:absolute; inset:-1px; border-radius:18px; background:linear-gradient(180deg,rgba(255,255,255,.25),transparent 60%); pointer-events:none; mix-blend-mode:screen}
.meta{margin-top:6px; font-size:10px; color:var(--sub)}

footer{padding:8px 16px 18px}
.composer{display:flex; gap:10px; background:#fff; border:1px solid #ead4dd; border-radius:22px; padding:10px; box-shadow:0 10px 28px rgba(30,10,20,.06)}
textarea{flex:1; resize:none; background:#fffdfd; border:0; outline:0; border-radius:14px; min-height:82px; padding:10px 12px; font-size:14px; font-family:'MongmongDays','SUIT',ui-sans-serif}
.hint{color:var(--sub); font-size:11px; margin-top:6px}
.small{color:var(--sub); font-size:11px; padding:8px 16px 16px}
</style>
</head>
<body>
<div class="wrap-bg"></div>

<!-- Particles -->
<div class="particles" id="particles"></div>

<!-- COVER -->
<div class="splash" id="splash">
  <div class="cover3d">
    <div class="book" id="book">
      <div class="case"></div>
      <div class="ring"></div>

      <div class="cover">
        <div class="frame"></div>
        <div class="cover-title">I(LO)VEME💗 Diary</div>
        <div class="heart-window">
          <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="heartGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#ffd4e7"/>
                <stop offset="100%" stop-color="#ff8fb6"/>
              </linearGradient>
              <linearGradient id="wingGrad" x1="0" x2="1" y1="0" y2="0">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#f2ecff"/>
              </linearGradient>
              <clipPath id="heartClip">
                <path d="M100,75 C85,60 55,47 55,30 C55,17 66,10 76,10 C86,10 95,16 100,25
                        C105,16 114,10 124,10 C134,10 145,17 145,30 C145,47 115,60 100,75 Z"/>
              </clipPath>
            </defs>

            <path class="wing" d="M55,45 c-18,-6 -30,-2 -36,3 c8,0 16,2 24,6 c-8,0 -14,3 -19,7
                                   c9,-1 16,1 23,4 c-6,1 -10,4 -12,7 c8,-2 15,0 21,2 c-5,2 -8,4 -9,7
                                   c7,-2 13,-1 18,1" fill="url(#wingGrad)" stroke="#eae3ff" stroke-width="0.6"/>
            <path class="wing" d="M145,45 c18,-6 30,-2 36,3 c-8,0 -16,2 -24,6 c8,0 14,3 19,7
                                   c-9,-1 -16,1 -23,4 c6,1 10,4 12,7 c-8,-2 -15,0 -21,2 c5,2 8,4 9,7
                                   c-7,-2 -13,-1 -18,1" fill="url(#wingGrad)" stroke="#eae3ff" stroke-width="0.6"/>
            <g clip-path="url(#heartClip)">
              <rect x="45" y="5" width="110" height="90" class="heart-fill"/>
              <ellipse cx="92" cy="26" rx="18" ry="10" fill="rgba(255,255,255,.55)"/>
            </g>
            <path d="M100,75 C85,60 55,47 55,30 C55,17 66,10 76,10 C86,10 95,16 100,25
                     C105,16 114,10 124,10 C134,10 145,17 145,30 C145,47 115,60 100,75 Z"
                  fill="none" stroke="#e6dfe6" stroke-width="4"/>
          </svg>
        </div>
        <button class="open-btn" id="openDiary">열기</button>
        <div class="hint">다이어리 쓰기!</div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="wrap" id="app" style="visibility:hidden">
  <header>
    <div class="hero">
      <div class="emoji">🩰</div>
      <div>
        <div class="title">I(LO)VEME💗 Diary</div>
        <small>IVE가 들어줄게! TeLL Me Your Secret!</small>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn" id="copyLast">응원 복사</button>
        <button class="btn" id="showCover">표지 다시 보기</button>
      </div>
    </div>

    <div class="topbar">
      <div style="display:flex; gap:8px;">
        <button class="btn" id="export">내보내기</button>
        <button class="btn" id="clear">모두 삭제</button>
      </div>
      <button class="btn btn-primary" id="scrollBottom">⬇ 대화 맨아래</button>
    </div>
  </header>

  <section class="tone">
    <button data-tone="warm">💗 IVE 웅니</button>
    <button data-tone="itgirl" class="active">🎀 Itgirl VIBE</button>
    <button data-tone="coach">🎯 코치모드!</button>
  </section>

  <div class="presets" id="presets"></div>

  <main>
    <div class="paper">
      <div class="list" id="list"></div>
    </div>
  </main>

  <footer>
    <div class="composer">
      <textarea id="input" placeholder="오늘의 마음을 알려줘! 나만 알고있을게!✍️"></textarea>
      <button class="btn btn-primary" id="send">보내기</button>
    </div>
    <div class="hint">로컬 저장: 이 페이지의 기록은 이 기기(localStorage)에만 저장됩니다.</div>
  </footer>

  <div class="small">server time: {{ now }}</div>
</div>

<script>
/* Cover open/close */
const KEY="ive-cover-seen";
const splash=document.getElementById('splash');
const app=document.getElementById('app');
const openBtn=document.getElementById('openDiary');
const showCover=document.getElementById('showCover');
function openBook(){ document.querySelector('.cover3d').classList.add('opening'); setTimeout(()=>{ splash.classList.add('hide'); app.style.visibility='visible'; localStorage.setItem(KEY,'1'); }, 1200); }
function showBook(){ splash.classList.remove('hide'); app.style.visibility='hidden'; document.querySelector('.cover3d').classList.remove('opening'); }
if(localStorage.getItem(KEY)==='1'){ splash.classList.add('hide'); app.style.visibility='visible'; }
openBtn.addEventListener('click', openBook);
showCover.addEventListener('click', ()=>{ localStorage.removeItem(KEY); showBook(); });

/* Particles: white/pearl/lilac + subtle stroke */
const particles = document.getElementById('particles');
const svgs = [
  // heart (white stroke)
  `<svg viewBox="0 0 40 36" xmlns="http://www.w3.org/2000/svg">
     <defs><linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
       <stop offset="0%" stop-color="#fff8fd"/><stop offset="100%" stop-color="#ffe7f2"/></linearGradient></defs>
     <path d="M20,32 C9,24 2,19 2,11 C2,6 6,3 10,3 c4,0 7,2 10,6 c3,-4 6,-6 10,-6 c4,0 8,3 8,8 c0,8 -7,13 -18,21 z"
           fill="url(#g1)" stroke="#ffffff" stroke-width="0.6" />
   </svg>`,
  // ribbon (pearl white)
  `<svg viewBox="0 0 60 36" xmlns="http://www.w3.org/2000/svg">
     <linearGradient id="g2" x1="0" x2="1" y1="0" y2="0"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#f5f0ff"/></linearGradient>
     <path d="M30 18c8-6 18-10 26-10-5 6-10 12-16 18-4 4-7 6-10 4-3 2-6 0-10-4C14 20 9 14 4 8c8 0 18 4 26 10z"
           fill="url(#g2)" opacity=".95" stroke="#ffffff" stroke-width="0.5"/>
     <circle cx="30" cy="18" r="4" fill="#fff0fa" stroke="#ffffff" stroke-width="0.4"/>
   </svg>`,
  // pearl (lilac glow)
  `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
     <radialGradient id="g3" cx="50%" cy="40%" r="60%">
       <stop offset="0%" stop-color="#ffffff"/><stop offset="60%" stop-color="#f6f1ff"/><stop offset="100%" stop-color="#e8dbff"/></radialGradient>
     <circle cx="12" cy="12" r="8" fill="url(#g3)" stroke="#ffffff" stroke-width="0.5"/>
   </svg>`
];
function spawn() {
  const el = document.createElement('div');
  el.className = 'particle';
  el.innerHTML = svgs[Math.floor(Math.random()*svgs.length)];
  const size = 16 + Math.random()*28;
  el.style.left = Math.random()*100 + 'vw';
  el.style.bottom = (-10 + Math.random()*20) + 'vh';
  el.style.width = size + 'px';
  const dur = 18 + Math.random()*16;
  el.style.animationDuration = dur + 's, ' + (3 + Math.random()*3) + 's';
  el.style.animationDelay = (Math.random()*8) + 's, 0s';
  particles.appendChild(el);
  setTimeout(()=>el.remove(), (dur+1)*1000);
}
for(let i=0;i<20;i++) spawn();
setInterval(()=>spawn(), 1800);

/* App logic */
const LS="ive-diary-contrast-v1";
const $=(s)=>document.querySelector(s);
const listEl=$("#list"), inputEl=$("#input");
const sendBtn=$("#send"), exportBtn=$("#export"), clearBtn=$("#clear");
const copyBtn=$("#copyLast"), sbBtn=$("#scrollBottom");
const toneBtns=document.querySelectorAll(".tone button");
const presetsEl=$("#presets");

const presets=[
  "나 오늘 힘들었어. 어떻게 하면 좋을까?",
  "요즘 자신감이 떨어지는 느낌이야.",
  "실수를 해서 너무 속상해.",
  "사람 관계가 어려워…",
  "새로운 도전 앞이라 떨려.",
  "미루게 돼서 루틴을 만들고 싶어.",
];

let tone="itgirl"; let entries=[];
try{ entries=JSON.parse(localStorage.getItem(LS)||"[]"); }catch(e){ entries=[]; }

presets.forEach(p=>{ const b=document.createElement("button"); b.className="chip"; b.textContent=p; b.onclick=()=>sendMessage(p); presetsEl.appendChild(b); });
toneBtns.forEach(btn=>btn.addEventListener("click",()=>{ toneBtns.forEach(b=>b.classList.remove("active")); btn.classList.add("active"); tone=btn.dataset.tone; }));

function render(){
  listEl.innerHTML="";
  entries.forEach(item=>{
    const div=document.createElement("div");
    div.className="bubble "+(item.role==="user"?"me":"ive");
    div.textContent=item.text;
    const meta=document.createElement("div");
    meta.className="meta";
    meta.textContent=(item.role==="user"?"나의 기록 · ":"IVE 응원 · ")+new Date(item.time).toLocaleString();
    div.appendChild(meta);
    listEl.appendChild(div);
  });
  listEl.scrollTop=999999;
  localStorage.setItem(LS, JSON.stringify(entries));
}
render();

async function sendMessage(text){
  const content=(text ?? inputEl.value).trim();
  if(!content) return;
  const now=new Date().toISOString();
  entries.push({role:"user", text:content, time:now, tone}); render(); inputEl.value="";
  try{
    const res=await fetch("/reply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:content,tone})});
    const data=await res.json();
    if(data?.reply){ entries.push({role:"ive", text:data.reply, time:data.time, tone}); render(); }
  }catch(e){
    entries.push({role:"ive", text:"서버 연결에 잠시 문제가 있어요. 곧 다시 시도해줘 💗", time:new Date().toISOString(), tone}); render();
  }
}

sendBtn.addEventListener("click", ()=>sendMessage());
inputEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
exportBtn?.addEventListener("click", ()=>{ const blob=new Blob([JSON.stringify(entries,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="ive-diary.json"; a.click(); URL.revokeObjectURL(url); });
clearBtn?.addEventListener("click", ()=>{ if(confirm("모든 대화를 삭제할까요?")){ entries=[]; render(); }});
copyBtn?.addEventListener("click", ()=>{ const last=[...entries].reverse().find(e=>e.role==="ive"); if(!last) return; navigator.clipboard.writeText(last.text).then(()=>alert("마지막 응원문구를 복사했어요 💖")); });
sbBtn?.addEventListener("click", ()=>{ listEl.scrollTop=999999; });
</script>
</body>
</html>
"""

# ---------------- 4) Run ----------------
if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--host", default="127.0.0.1")
    parser.add_argument("--port", default=5000, type=int)
    args = parser.parse_args()
    app.run(host=args.host, port=args.port, debug=True)
